package io.mehow.laboratory.gradle

import org.gradle.api.Action
import org.gradle.api.Project

/**
 * An entry point for configuration of feature flags code generation.
 */
@Suppress("UnnecessaryAbstractClass") // Created by Gradle
public abstract class LaboratoryExtension {
  /**
   * Sets package name for any factories or feature flags defined in this extension.
   * Package names can be individually overwritten in each generating block
   */
  public var packageName: String = ""

  private val mutableFeatureInputs = mutableListOf<FeatureFlagInput>()

  internal val featureInputs: List<FeatureFlagInput> = mutableFeatureInputs

  internal lateinit var project: Project

  /**
   * Generates a new feature in this module.
   */
  public fun feature(name: String, action: Action<FeatureFlagInput>) {
    mutableFeatureInputs += FeatureFlagInput(name, { packageName }).let { input ->
      action.execute(input)
      return@let input
    }
  }

  internal var factoryInput: FeatureFactoryInput? = null
    private set

  /**
   * Generates a new feature factory in this module. This should generally be used only by a
   * top level module that needs to have information about all feature flags for QA purposes.
   */
  public fun featureFactory(): Unit = featureFactory { }

  /**
   * Generates and customizes a new feature factory in this module.
   * This should generally be used only by a top level module
   * that needs to have information about all feature flags for QA purposes.
   */
  public fun featureFactory(action: Action<FeatureFactoryInput>) {
    factoryInput = FeatureFactoryInput { packageName }.let { input ->
      action.execute(input)
      return@let input
    }
  }

  internal var storageInput: SourcedFeatureStorageInput? = null
    private set

  /**
   * Generates a new feature storage in this module. This should generally be used only by a
   * top level module that needs to to have information about all sources.
   * Feature storage generated by this method should be then used in the application.
   */
  public fun sourcedStorage(): Unit = sourcedStorage { }

  /**
   * Generates and customizes a new feature storage in this module.
   * This should generally be used only by a top level module
   * that needs to to have information about all sources.
   * Feature storage generated by this method should be then used in the application.
   */
  public fun sourcedStorage(action: Action<SourcedFeatureStorageInput>) {
    storageInput = SourcedFeatureStorageInput { packageName }.let { input ->
      action.execute(input)
      return@let input
    }
  }

  internal var featureSourcesFactory: FeatureFactoryInput? = null
    private set

  /**
   * Generates a new feature sources factory in this module. This should generally be used only by a
   * top level module that needs to have information about all feature flags for QA purposes.
   */
  public fun featureSourceFactory(): Unit = featureSourceFactory { }

  /**
   * Generates a new feature sources factory in this module.
   * This should generally be used only by a top level module
   * that needs to have information about all feature flags for QA purposes.
   */
  public fun featureSourceFactory(action: Action<FeatureFactoryInput>) {
    featureSourcesFactory = FeatureFactoryInput { packageName }.let { input ->
      action.execute(input)
      return@let input
    }
  }

  internal var optionFactoryInput: OptionFactoryInput? = null
    private set

  /**
   * Generates a new option factory in this module. All features that can be created by this factory must
   * be visible to it during compilation.
   */
  public fun optionFactory(): Unit = optionFactory { }

  /**
   * Generates a new option factory in this module. All features that can be created by this factory must
   * be visible to it during compilation.
   */
  public fun optionFactory(action: Action<OptionFactoryInput>) {
    optionFactoryInput = OptionFactoryInput { packageName }.let { input ->
      action.execute(input)
      return@let input
    }
  }
}
